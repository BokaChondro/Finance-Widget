<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Casino Royale Finance - VIP Room</title>
  
  <!-- High-End Casino Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Playfair+Display:wght@700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* --- 1. THEME ENGINE & LAYOUT --- */
    :root {
      --bg: #191919;
      --felt-color: #0d361c;
      --felt-highlight: #16522c;
      --bumper-color: #1a0f0a;
      
      --gold-solid: #D4AF37;
      --gold-grad: linear-gradient(135deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
      --gold-glow: drop-shadow(0 0 10px rgba(212, 175, 55, 0.4));
      
      --neon-green: #39FF14;
      --neon-red: #FF003C;
      --text-main: #EAEAEA;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg);
      background-image: radial-gradient(circle at center, #222 0%, #111 100%);
      color: var(--text-main);
      font-family: "Space Mono", monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 2vw;
    }

    /* 2x2 Grid Layout */
    .casino-floor {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1400px;
      height: 100%;
      max-height: 900px;
    }

    /* --- 2. CASINO TABLE CARDS (FELT & WOOD BUMPER) --- */
    .table-card {
      position: relative;
      background-color: var(--felt-color);
      /* Highly realistic casino felt texture */
      background-image: 
        radial-gradient(circle at 50% 0%, var(--felt-highlight) 0%, transparent 70%),
        url('data:image/svg+xml;utf8,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noise"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noise)" opacity="0.12"/%3E%3C/svg%3E');
      border-radius: 28px;
      border: 14px solid var(--bumper-color); /* Leather bumper */
      box-shadow: 
        inset 0 0 0 3px #000, 
        inset 0 0 0 6px var(--gold-solid), 
        inset 0 0 40px rgba(0,0,0,0.8),
        0 15px 35px rgba(0,0,0,0.5);
      padding: 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }

    /* Card Labels */
    .card-title {
      font-family: "Cinzel", serif;
      font-size: 1.2rem;
      letter-spacing: 3px;
      color: var(--gold-solid);
      text-align: center;
      text-shadow: 0 4px 10px rgba(0,0,0,1);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .card-title::before, .card-title::after {
      content: ''; flex: 1; height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold-solid), transparent);
    }

    /* --- 3. SLOT MACHINE DISPLAY --- */
    .slot-window {
      background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 15%, #1a1a1a 85%, #0a0a0a 100%);
      border-radius: 12px;
      border: 3px solid #000;
      box-shadow: 
        inset 0 10px 20px rgba(0,0,0,0.9),
        0 2px 0 rgba(255,255,255,0.1);
      height: 90px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 0 20px;
      margin: 15px 0;
    }
    
    /* Slot Machine Glass Reflection */
    .slot-window::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 40%;
      background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 100%);
      pointer-events: none;
      border-radius: 12px 12px 0 0;
    }

    /* The Reels Container */
    .slot-machine {
      display: flex;
      align-items: center;
      font-family: "Playfair Display", serif;
      font-size: 3.5rem;
      font-weight: 900;
      line-height: 1;
    }

    /* Currency Symbol */
    .currency-symbol {
      margin-right: 12px;
      color: var(--gold-solid);
      filter: var(--gold-glow);
    }

    /* Individual Reel CSS */
    .reel-wrapper {
      height: 1em;
      overflow: hidden;
      position: relative;
      display: inline-block;
      vertical-align: top;
      margin: 0 1px;
    }
    
    .reel-strip {
      display: flex;
      flex-direction: column;
      will-change: transform;
    }
    
    .reel-digit {
      height: 1em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .static-char { margin: 0 2px; }

    /* Thematic Colors for Digits */
    .theme-gold .reel-strip, .theme-gold .static-char {
      background: var(--gold-grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: var(--gold-glow);
    }
    .theme-green .reel-strip, .theme-green .static-char {
      color: var(--neon-green);
      text-shadow: 0 0 15px rgba(57, 255, 20, 0.6);
    }
    .theme-red .reel-strip, .theme-red .static-char {
      color: var(--neon-red);
      text-shadow: 0 0 15px rgba(255, 0, 60, 0.6);
    }

    /* --- 4. SUB-INFO & DEALER INSIGHTS --- */
    .sub-info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #9ab3a1;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
      margin-top: auto;
    }
    .sub-val { color: var(--gold-solid); }
    .debt-val { color: #ff6b6b; }

    /* 3D Dealer Card Flipper */
    .dealer-card-container {
      perspective: 1000px;
      height: 40px;
      width: 100%;
      margin-top: auto;
    }
    .dealer-card {
      width: 100%; height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy flip */
    }
    .dealer-card.flipped { transform: rotateX(180deg); }
    
    .dealer-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 15px;
      font-size: 0.75rem;
      color: #e0e0e0;
      text-align: center;
    }
    .dealer-back {
      transform: rotateX(180deg);
      border-color: rgba(57, 255, 20, 0.3);
    }

    /* Loading Overlay */
    #loader {
      position: fixed; inset: 0;
      background: #000; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
    }
    .chip-loader {
      width: 60px; height: 60px;
      border: 6px dashed var(--gold-solid);
      border-radius: 50%;
      animation: spin 2s linear infinite;
    }
    .loader-text {
      margin-top: 20px; color: var(--gold-solid);
      font-family: "Cinzel", serif; font-size: 1.2rem; letter-spacing: 4px;
      animation: pulse 1s infinite alternate;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .casino-floor { grid-template-columns: 1fr; grid-template-rows: auto; }
      .slot-machine { font-size: 2.8rem; }
      .slot-window { height: 75px; }
      body { overflow-y: auto; padding: 20px; }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loader">
    <div class="chip-loader"></div>
    <div class="loader-text">THE DEALER IS SHUFFLING...</div>
  </div>

  <div class="casino-floor">
    
    <!-- 1. TRUE NET WORTH -->
    <div class="table-card">
      <div class="card-title">üíé TRUE NET WORTH</div>
      <div class="slot-window">
        <div class="slot-machine theme-gold">
          <span class="currency-symbol">‡ß≥</span>
          <div id="slot-net" class="reels-container"></div>
        </div>
      </div>
      <div class="sub-info-row">
        <div>LIQUID: <span class="sub-val" id="lbl-bal">...</span></div>
        <div>HOUSE DEBT: <span class="debt-val" id="lbl-debt">...</span></div>
      </div>
    </div>

    <!-- 2. MONTHLY CASHFLOW -->
    <div class="table-card">
      <div class="card-title">‚öñÔ∏è MONTHLY HAND</div>
      <div class="slot-window">
        <div class="slot-machine" id="theme-flow">
          <span class="currency-symbol">‡ß≥</span>
          <div id="slot-flow" class="reels-container"></div>
        </div>
      </div>
      <div class="dealer-card-container">
        <div class="dealer-card" id="dealer-flow">
          <div class="dealer-face front">Reading the table...</div>
          <div class="dealer-face dealer-back back">Calculating odds...</div>
        </div>
      </div>
    </div>

    <!-- 3. INCOME -->
    <div class="table-card">
      <div class="card-title">üíµ WINNINGS (IN)</div>
      <div class="slot-window">
        <div class="slot-machine theme-green">
          <span class="currency-symbol">‡ß≥</span>
          <div id="slot-inc" class="reels-container"></div>
        </div>
      </div>
      <div class="dealer-card-container">
        <div class="dealer-card" id="dealer-inc">
          <div class="dealer-face front">Counting chips...</div>
          <div class="dealer-face dealer-back back">...</div>
        </div>
      </div>
    </div>

    <!-- 4. EXPENSE -->
    <div class="table-card">
      <div class="card-title">üìâ LOSSES (OUT)</div>
      <div class="slot-window">
        <div class="slot-machine theme-red">
          <span class="currency-symbol">‡ß≥</span>
          <div id="slot-exp" class="reels-container"></div>
        </div>
      </div>
      <div class="dealer-card-container">
        <div class="dealer-card" id="dealer-exp">
          <div class="dealer-face front">Reviewing the bets...</div>
          <div class="dealer-face dealer-back back">...</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /**
     * üé∞ CASINO SLOT MACHINE ANIMATION ENGINE
     */
    class SlotMachine {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
      }

      // Pre-fill reels so they look like they are spinning instantly on load
      prepareSpinning() {
        this.container.innerHTML = '<div style="font-size:1.5rem; letter-spacing:4px; opacity:0.5; animation:pulse 1s infinite alternate;">SPINNING...</div>';
      }

      async spinTo(targetValue, isNegative = false) {
        this.container.innerHTML = ''; // Clear container
        
        // Setup negative sign if applicable
        if (isNegative) {
          const negSign = document.createElement('div');
          negSign.className = 'static-char';
          negSign.innerText = '-';
          this.container.appendChild(negSign);
        }

        // Format number with commas
        const valStr = Math.abs(targetValue).toLocaleString('en-US');
        const stripsToAnimate =[];

        // Build DOM for reels
        for (let i = 0; i < valStr.length; i++) {
          const char = valStr[i];
          
          if (char === ',') {
            const comma = document.createElement('div');
            comma.className = 'static-char';
            comma.innerText = ',';
            this.container.appendChild(comma);
          } else {
            const wrapper = document.createElement('div');
            wrapper.className = 'reel-wrapper';
            
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            
            // Generate standard digits 0-9 repeatedly to simulate long spin
            // 4 loops of 0-9 = 40 digits
            let sequenceHTML = '';
            for(let loop = 0; loop < 4; loop++) {
              for(let d = 0; d <= 9; d++) {
                sequenceHTML += `<div class="reel-digit">${d}</div>`;
              }
            }
            // Append final target digit at the very bottom
            sequenceHTML += `<div class="reel-digit target-digit">${char}</div>`;
            
            strip.innerHTML = sequenceHTML;
            wrapper.appendChild(strip);
            this.container.appendChild(wrapper);
            
            stripsToAnimate.push(strip);
          }
        }

        // Wait a frame for DOM rendering to measure heights correctly
        await new Promise(r => requestAnimationFrame(r));

        // Trigger Animations sequentially (Left to Right)
        stripsToAnimate.forEach((strip, index) => {
          // Calculate offset based on child height
          const itemHeight = strip.children[0].getBoundingClientRect().height;
          const totalItems = strip.children.length;
          const finalOffset = -((totalItems - 1) * itemHeight);

          // Staggering delay for realistic left-to-right reel locking
          const delay = index * 300; 

          setTimeout(() => {
            // Easing: Pulls back slightly, spins fast, then bounces slightly on lock
            strip.style.transition = 'transform 3.5s cubic-bezier(0.15, 0.85, 0.2, 1.1)';
            strip.style.transform = `translateY(${finalOffset}px)`;
          }, delay + 100);
        });
      }
    }

    /**
     * üÉè THE DEALER (Card Flipper Logic)
     */
    class Dealer {
      constructor(cardId, messages) {
        this.card = document.getElementById(cardId);
        this.front = this.card.querySelector('.front');
        this.back = this.card.querySelector('.back');
        this.messages = messages || ["All bets settled."];
        this.currentIndex = 0;
      }

      startDealing() {
        if(this.messages.length <= 1) {
            this.front.innerText = this.messages[0];
            return;
        }
        
        this.front.innerText = this.messages[0];
        
        setInterval(() => {
          this.currentIndex = (this.currentIndex + 1) % this.messages.length;
          
          if (!this.card.classList.contains('flipped')) {
            this.back.innerText = this.messages[this.currentIndex];
            this.card.classList.add('flipped');
          } else {
            this.front.innerText = this.messages[this.currentIndex];
            this.card.classList.remove('flipped');
          }
        }, 7000); // Flips every 7 seconds
      }
    }

    /**
     * üöÄ MAIN INITIALIZATION
     */
    async function initCasino() {
      // Instantiate Slots
      const slots = {
        net: new SlotMachine('slot-net'),
        flow: new SlotMachine('slot-flow'),
        inc: new SlotMachine('slot-inc'),
        exp: new SlotMachine('slot-exp')
      };

      Object.values(slots).forEach(s => s.prepareSpinning());

      try {
        // Fetch Data from your Cloudflare Worker
        const res = await fetch('/api?t=' + Date.now());
        if (!res.ok) throw new Error("API Route failed");
        const data = await res.json();
        
        if(data.backendError) throw new Error(data.backendError);

        // Hide Loader
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

        // 1. Trigger Net Worth
        slots.net.spinTo(data.summary.netWorth, data.summary.netWorth < 0);
        document.getElementById('lbl-bal').innerText = '‡ß≥' + data.summary.balance.toLocaleString();
        document.getElementById('lbl-debt').innerText = '‡ß≥' + data.summary.totalDebt.toLocaleString();

        // 2. Trigger Cashflow & dynamic theme
        const flowTheme = document.getElementById('theme-flow');
        if (data.kpis.current.cashflow >= 0) {
            flowTheme.classList.add('theme-green');
        } else {
            flowTheme.classList.add('theme-red');
        }
        slots.flow.spinTo(data.kpis.current.cashflow, data.kpis.current.cashflow < 0);
        
        new Dealer('dealer-flow', data.insights.cashflow).startDealing();

        // 3. Trigger Income
        slots.inc.spinTo(data.kpis.current.income);
        new Dealer('dealer-inc', data.insights.income).startDealing();

        // 4. Trigger Expense
        slots.exp.spinTo(data.kpis.current.expense);
        new Dealer('dealer-exp', data.insights.expense).startDealing();

      } catch (e) {
        console.error("Casino Systems Error:", e);
        
        // FAILSAFE / DEMO MODE (If API is unreachable, play the animations anyway!)
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

        slots.net.spinTo(1245000);
        document.getElementById('lbl-bal').innerText = "‡ß≥245,000";
        document.getElementById('lbl-debt').innerText = "‡ß≥12,000";

        document.getElementById('theme-flow').classList.add('theme-green');
        slots.flow.spinTo(45200);
        new Dealer('dealer-flow', ["API Disconnected.", "Loading offline chips...", "Simulated Hand."]).startDealing();

        slots.inc.spinTo(85000);
        new Dealer('dealer-inc', ["Fallback data applied.", "The house always wins."]).startDealing();

        slots.exp.spinTo(39800);
        new Dealer('dealer-exp', ["Offline tracking active.", "Minimize your losses."]).startDealing();
      }
    }

    // Enter the VIP Lounge
    window.onload = initCasino;
  </script>
</body>
</html>
