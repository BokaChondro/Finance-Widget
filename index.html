<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sci-Fi Finance HUD</title>
  
  <!-- High-End Cyber Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">

  <style>
    /* --- 1. CORE VARIABLES --- */
    :root {
      --bg-color: #191919;
      --card-bg: rgba(10, 12, 16, 0.7);
      
      --neon-white: #ffffff;
      --neon-green: #00ff66;
      --neon-red: #ff0044;
      --neon-yellow: #ffcc00;
      
      --text-main: #e2e8f0;
      --text-gray: #64748b;
      --text-dark: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 30px;
      overflow-x: hidden;
    }

    /* --- 2. LAYOUT: 1x4 Left, 1 Big Right --- */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 30px;
      width: 100%;
      max-width: 1800px;
      margin: 0 auto;
      height: calc(100vh - 60px);
    }

    .left-column {
      display: grid;
      grid-template-rows: repeat(4, 1fr);
      gap: 20px;
      height: 100%;
    }

    /* --- 3. HIGH-EFFORT HUD CARDS --- */
    .hud-card {
      background: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      padding: 20px 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* Sci-Fi Targeting Corners */
    .hud-card::before, .hud-card::after {
      content: ''; position: absolute; width: 15px; height: 15px;
      pointer-events: none;
    }
    .hud-card::before {
      top: 0; left: 0;
      border-top: 2px solid; border-left: 2px solid;
    }
    .hud-card::after {
      bottom: 0; right: 0;
      border-bottom: 2px solid; border-right: 2px solid;
    }

    /* Scanline Overlay */
    .scanlines {
      position: absolute; inset: 0; pointer-events: none;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
      background-size: 100% 4px; z-index: 1; opacity: 0.4;
    }

    /* Header */
    .hud-header {
      display: flex; justify-content: space-between; align-items: center;
      position: relative; z-index: 2;
    }
    .hud-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem; letter-spacing: 3px; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    .hud-sys {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem; color: var(--text-dark); letter-spacing: 2px;
    }

    /* Number Display Box (Left-Aligned Taka, Right-Aligned Number) */
    .hud-number-box {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 2px;
      padding: 12px 20px;
      margin: 15px 0;
      display: flex;
      justify-content: space-between; /* Perfect Alignment */
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .currency {
      font-family: 'Space Mono', monospace;
      font-size: 1.5rem; opacity: 0.7;
    }
    .amount {
      font-family: 'Space Mono', monospace;
      font-size: 2.2rem; font-weight: 700;
      letter-spacing: -1px; text-align: right; width: 100%;
    }

    /* Footer / Sub-stats */
    .hud-footer {
      display: flex; justify-content: space-between;
      font-size: 0.85rem; font-family: 'Space Mono', monospace;
      position: relative; z-index: 2;
    }
    .hud-footer span { font-weight: 700; }

    /* --- 4. THEMES & DYNAMIC COLORS --- */
    
    /* White (Net Worth) */
    .theme-white .hud-card::before, .theme-white .hud-card::after { border-color: var(--neon-white); }
    .theme-white .hud-title { color: var(--neon-white); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .theme-white .amount { color: var(--neon-white); text-shadow: 0 0 15px rgba(255,255,255,0.5); }

    /* Green (Income) */
    .theme-green .hud-card::before, .theme-green .hud-card::after { border-color: var(--neon-green); }
    .theme-green .hud-title { color: var(--neon-green); text-shadow: 0 0 10px rgba(0,255,102,0.5); }
    .theme-green .amount { color: var(--neon-green); text-shadow: 0 0 15px rgba(0,255,102,0.5); }
    .theme-green .currency { color: var(--neon-green); }

    /* Red (Expense) */
    .theme-red .hud-card::before, .theme-red .hud-card::after { border-color: var(--neon-red); }
    .theme-red .hud-title { color: var(--neon-red); text-shadow: 0 0 10px rgba(255,0,68,0.5); }
    .theme-red .amount { color: var(--neon-red); text-shadow: 0 0 15px rgba(255,0,68,0.5); }
    .theme-red .currency { color: var(--neon-red); }

    /* Cashflow Pulse Animations (Yellow <-> Green OR Yellow <-> Red) */
    @keyframes pulse-yellow-green {
      0% { border-color: var(--neon-yellow); box-shadow: 0 0 0 rgba(255, 204, 0, 0); }
      50% { border-color: var(--neon-green); box-shadow: inset 10px 0 30px -10px rgba(0,255,102,0.2); }
      100% { border-color: var(--neon-yellow); box-shadow: 0 0 0 rgba(255, 204, 0, 0); }
    }
    @keyframes text-yellow-green {
      0% { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(255,204,0,0.5); }
      50% { color: var(--neon-green); text-shadow: 0 0 15px rgba(0,255,102,0.6); }
      100% { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(255,204,0,0.5); }
    }

    @keyframes pulse-yellow-red {
      0% { border-color: var(--neon-yellow); box-shadow: 0 0 0 rgba(255, 204, 0, 0); }
      50% { border-color: var(--neon-red); box-shadow: inset 10px 0 30px -10px rgba(255,0,68,0.2); }
      100% { border-color: var(--neon-yellow); box-shadow: 0 0 0 rgba(255, 204, 0, 0); }
    }
    @keyframes text-yellow-red {
      0% { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(255,204,0,0.5); }
      50% { color: var(--neon-red); text-shadow: 0 0 15px rgba(255,0,68,0.6); }
      100% { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(255,204,0,0.5); }
    }

    /* Assign dynamically via JS */
    .pulse-yg .hud-card { animation: pulse-yellow-green 3s infinite ease-in-out; border-left: 2px solid; }
    .pulse-yg .hud-card::before, .pulse-yg .hud-card::after { animation: border-yellow-green 3s infinite ease-in-out; }
    .pulse-yg .hud-title, .pulse-yg .amount, .pulse-yg .currency { animation: text-yellow-green 3s infinite ease-in-out; }

    .pulse-yr .hud-card { animation: pulse-yellow-red 3s infinite ease-in-out; border-left: 2px solid; }
    .pulse-yr .hud-card::before, .pulse-yr .hud-card::after { animation: border-yellow-red 3s infinite ease-in-out; }
    .pulse-yr .hud-title, .pulse-yr .amount, .pulse-yr .currency { animation: text-yellow-red 3s infinite ease-in-out; }


    /* Utility Text Colors */
    .text-gray { color: var(--text-gray); }
    .text-white { color: var(--neon-white); }
    .text-up { color: var(--neon-green); text-shadow: 0 0 8px rgba(0,255,102,0.4); }
    .text-down { color: var(--neon-red); text-shadow: 0 0 8px rgba(255,0,68,0.4); }

    /* --- 5. BLANK RIGHT COLUMN (SCI-FI AESTHETIC) --- */
    .blank-chart-box {
      background: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }
    .blank-chart-box::before {
      content: ''; position: absolute;
      width: 400px; height: 400px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 50%;
    }
    .blank-text {
      font-family: 'Orbitron', sans-serif;
      color: var(--text-dark);
      font-size: 1.2rem; letter-spacing: 8px;
      z-index: 2;
    }

    /* Loader */
    #loader {
      position: fixed; inset: 0; background: var(--bg-color); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s;
    }
    .loader-ring {
      width: 50px; height: 50px;
      border: 2px solid rgba(255,255,255,0.1);
      border-top-color: var(--neon-white);
      border-radius: 50%;
      animation: spin 1s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loader">
    <div class="loader-ring"></div>
    <div style="margin-top:20px; font-family:'Orbitron', sans-serif; color:var(--text-gray); font-size:0.8rem; letter-spacing:6px;">DECRYPTING LEDGER...</div>
  </div>

  <div class="dashboard-layout">
    
    <!-- LEFT COLUMN -->
    <div class="left-column">
      
      <!-- 1. NET WORTH (WHITE) -->
      <div class="theme-white">
        <div class="hud-card">
          <div class="scanlines"></div>
          <div class="hud-header">
            <div class="hud-title">NET WORTH</div>
            <div class="hud-sys">SYS.OP.01</div>
          </div>
          <div class="hud-number-box">
            <div class="currency">à§³</div>
            <div class="amount" id="val-net">0</div>
          </div>
          <div class="hud-footer text-gray">
            <div>BALANCE: <span class="text-white" id="lbl-bal">...</span></div>
            <div>DEBT: <span class="text-white" id="lbl-debt">...</span></div>
          </div>
        </div>
      </div>

      <!-- 2. CASHFLOW (YELLOW BASE -> PULSE GREEN/RED) -->
      <div id="wrapper-flow">
        <div class="hud-card">
          <div class="scanlines"></div>
          <div class="hud-header">
            <div class="hud-title">CASHFLOW</div>
            <div class="hud-sys">SYS.OP.02</div>
          </div>
          <div class="hud-number-box">
            <div class="currency">à§³</div>
            <div class="amount" id="val-flow">0</div>
          </div>
          <div class="hud-footer">
            <div class="text-gray">vs prev month: <span id="flow-prev">...</span></div>
            <div class="text-gray">vs avg year: <span id="flow-avg">...</span></div>
          </div>
        </div>
      </div>

      <!-- 3. INCOME (GREEN) -->
      <div class="theme-green">
        <div class="hud-card">
          <div class="scanlines"></div>
          <div class="hud-header">
            <div class="hud-title">INCOME</div>
            <div class="hud-sys">SYS.OP.03</div>
          </div>
          <div class="hud-number-box">
            <div class="currency">à§³</div>
            <div class="amount" id="val-inc">0</div>
          </div>
          <div class="hud-footer">
            <div class="text-gray">vs prev month: <span id="inc-prev">...</span></div>
            <div class="text-gray">vs avg year: <span id="inc-avg">...</span></div>
          </div>
        </div>
      </div>

      <!-- 4. EXPENSE (RED) -->
      <div class="theme-red">
        <div class="hud-card">
          <div class="scanlines"></div>
          <div class="hud-header">
            <div class="hud-title">EXPENSE</div>
            <div class="hud-sys">SYS.OP.04</div>
          </div>
          <div class="hud-number-box">
            <div class="currency">à§³</div>
            <div class="amount" id="val-exp">0</div>
          </div>
          <div class="hud-footer">
            <div class="text-gray">vs prev month: <span id="exp-prev">...</span></div>
            <div class="text-gray">vs avg year: <span id="exp-avg">...</span></div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN: SCI-FI BLANK AREA -->
    <div class="right-column">
      <div class="blank-chart-box">
        <div class="scanlines"></div>
        <div class="blank-text">AWAITING TELEMETRY</div>
      </div>
    </div>

  </div>

  <script>
    /**
     * ðŸ“Ÿ SCI-FI CYAN DECRYPTION ENGINE
     * Replaces the slot machine entirely. 
     * Rapidly cycles matrix characters before locking into the correct number.
     * ZERO DOM clipping issues.
     */
    class CyberScramble {
      constructor(elementId) {
        this.element = document.getElementById(elementId);
        this.chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*X";
      }

      run(targetValue, isNegative = false) {
        const valStr = Math.abs(targetValue).toLocaleString('en-US');
        const finalStr = (isNegative ? "-" : "") + valStr;
        
        let iteration = 0;
        clearInterval(this.interval);
        
        this.interval = setInterval(() => {
          this.element.innerText = finalStr.split("").map((letter, index) => {
            if (letter === "," || letter === "-") return letter; // Keep symbols static
            if (index < iteration) return finalStr[index]; // Lock in correct digits left-to-right
            return this.chars[Math.floor(Math.random() * this.chars.length)]; // Scramble the rest
          }).join("");

          if (iteration >= finalStr.length) {
            clearInterval(this.interval);
            this.element.innerText = finalStr; // Ensure perfection at the end
          }

          iteration += 1 / 4; // Lower fraction = longer hacking effect
        }, 30);
      }
    }

    /**
     * ðŸ“Š PERCENTAGE CALCULATOR
     * Calculates % diff and returns styled HTML arrows exactly as requested.
     */
    function getStatHTML(current, previous, isExpense = false) {
      if (!previous || previous === 0) return `<span class="text-gray">0%</span>`;
      
      const diff = current - previous;
      const pct = Math.abs((diff / Math.abs(previous)) * 100).toFixed(0);
      
      const isUp = diff >= 0;
      // For expenses, going UP is BAD. For income/flow, going UP is GOOD.
      const isGood = isExpense ? !isUp : isUp; 
      
      const arrow = isUp ? 'â–²' : 'â–¼';
      const colorClass = isGood ? 'text-up' : 'text-down';

      return `<span class="${colorClass}">${arrow}${pct}%</span>`;
    }

    /**
     * ðŸš€ MAIN INITIALIZATION
     */
    async function init() {
      const display = {
        net: new CyberScramble('val-net'),
        flow: new CyberScramble('val-flow'),
        inc: new CyberScramble('val-inc'),
        exp: new CyberScramble('val-exp')
      };

      try {
        const res = await fetch('/api?t=' + Date.now());
        if (!res.ok) throw new Error("API Route failed");
        const data = await res.json();
        if(data.backendError) throw new Error(data.backendError);

        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        // 1. Net Worth (White)
        display.net.run(data.summary.netWorth, data.summary.netWorth < 0);
        document.getElementById('lbl-bal').innerText = 'à§³' + Math.abs(data.summary.balance).toLocaleString();
        document.getElementById('lbl-debt').innerText = 'à§³' + Math.abs(data.summary.totalDebt).toLocaleString();

        // 2. Cashflow (Dynamic Pulse)
        const flowWrapper = document.getElementById('wrapper-flow');
        if (data.kpis.current.cashflow >= 0) {
            flowWrapper.className = 'pulse-yg'; // Yellow to Green
        } else {
            flowWrapper.className = 'pulse-yr'; // Yellow to Red
        }
        display.flow.run(data.kpis.current.cashflow, data.kpis.current.cashflow < 0);
        document.getElementById('flow-prev').innerHTML = getStatHTML(data.kpis.current.cashflow, data.kpis.last.cashflow, false);
        document.getElementById('flow-avg').innerHTML = getStatHTML(data.kpis.current.cashflow, data.kpis.averages.flow, false);

        // 3. Income (Green)
        display.inc.run(data.kpis.current.income);
        document.getElementById('inc-prev').innerHTML = getStatHTML(data.kpis.current.income, data.kpis.last.income, false);
        document.getElementById('inc-avg').innerHTML = getStatHTML(data.kpis.current.income, data.kpis.averages.inc, false);

        // 4. Expense (Red)
        display.exp.run(data.kpis.current.expense);
        document.getElementById('exp-prev').innerHTML = getStatHTML(data.kpis.current.expense, data.kpis.last.expense, true);
        document.getElementById('exp-avg').innerHTML = getStatHTML(data.kpis.current.expense, data.kpis.averages.exp, true);

      } catch (e) {
        console.error("System Error:", e);
        
        // --- FALLBACK MOCK DATA (Triggers if API is unreachable) ---
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        display.net.run(1245000);
        document.getElementById('lbl-bal').innerText = "à§³245,000";
        document.getElementById('lbl-debt').innerText = "à§³12,000";

        // Mock Positive Cashflow (Pulses Yellow-to-Green)
        document.getElementById('wrapper-flow').className = 'pulse-yg';
        display.flow.run(45200);
        document.getElementById('flow-prev').innerHTML = getStatHTML(45200, 30000, false); // UP (Green)
        document.getElementById('flow-avg').innerHTML = getStatHTML(45200, 50000, false); // DOWN (Red)

        display.inc.run(85000);
        document.getElementById('inc-prev').innerHTML = getStatHTML(85000, 80000, false); // UP (Green)
        document.getElementById('inc-avg').innerHTML = getStatHTML(85000, 70000, false); // UP (Green)

        display.exp.run(39800);
        document.getElementById('exp-prev').innerHTML = getStatHTML(39800, 50000, true); // DOWN (Green for exp)
        document.getElementById('exp-avg').innerHTML = getStatHTML(39800, 30000, true); // UP (Red for exp)
      }
    }

    window.onload = init;
  </script>
</body>
</html>
