<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sci-Fi Finance HUD</title>
  
  <!-- Sci-Fi / Cyber Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">

  <style>
    /* --- 1. CORE SCI-FI VARIABLES --- */
    :root {
      --bg-dark: #03050a;
      --card-bg: rgba(6, 11, 25, 0.85);
      
      --neon-white: #ffffff;
      --neon-green: #00ff55;
      --neon-red: #ff0044;
      --neon-yellow: #fcee0a;
      
      --text-main: #e2e8f0;
      --text-muted: #64748b;
      
      --slot-height: 50px; 
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-dark);
      /* Sci-Fi Grid Background */
      background-image: 
        linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      color: var(--text-main);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 30px;
      overflow-x: hidden;
    }

    /* --- 2. LAYOUT: 1x4 Left, 1 Big Right --- */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 30px;
      width: 100%;
      max-width: 1800px;
      margin: 0 auto;
      height: calc(100vh - 60px);
    }

    .left-column {
      display: grid;
      grid-template-rows: repeat(4, 1fr);
      gap: 20px;
      height: 100%;
    }

    .right-column {
      display: flex;
      height: 100%;
    }

    /* --- 3. SCI-FI HUD CARDS --- */
    .kpi-card {
      background-color: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      /* Cyberpunk angled corner effect using clip-path */
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    }

    .card-title {
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-title::before {
      content: '';
      display: inline-block;
      width: 8px; height: 8px;
      background: currentColor;
      box-shadow: 0 0 10px currentColor;
    }

    /* Card Specific Neon Accents */
    .card-white {
      border-left: 4px solid var(--neon-white);
      box-shadow: inset 15px 0 30px -15px rgba(255,255,255,0.2);
    }
    .card-white .card-title { color: var(--neon-white); text-shadow: 0 0 10px rgba(255,255,255,0.5); }

    .card-green {
      border-left: 4px solid var(--neon-green);
      box-shadow: inset 15px 0 30px -15px rgba(0,255,85,0.2);
    }
    .card-green .card-title { color: var(--neon-green); text-shadow: 0 0 10px rgba(0,255,85,0.5); }

    .card-red {
      border-left: 4px solid var(--neon-red);
      box-shadow: inset 15px 0 30px -15px rgba(255,0,68,0.2);
    }
    .card-red .card-title { color: var(--neon-red); text-shadow: 0 0 10px rgba(255,0,68,0.5); }

    /* CASHFLOW: Default Yellow, Breathing Green/Red overrides applied via JS */
    .card-flow-base {
      border-left: 4px solid var(--neon-yellow);
      box-shadow: inset 15px 0 30px -15px rgba(252, 238, 10, 0.2);
    }
    .card-flow-base .card-title { color: var(--neon-yellow); text-shadow: 0 0 10px rgba(252, 238, 10, 0.5); }

    /* Breathing Animations */
    @keyframes breath-green {
      0% { border-left-color: #004411; box-shadow: inset 15px 0 30px -15px rgba(0,255,85,0.0); }
      50% { border-left-color: var(--neon-green); box-shadow: inset 15px 0 30px -15px rgba(0,255,85,0.4), 0 0 20px rgba(0,255,85,0.2); }
      100% { border-left-color: #004411; box-shadow: inset 15px 0 30px -15px rgba(0,255,85,0.0); }
    }
    @keyframes breath-red {
      0% { border-left-color: #440011; box-shadow: inset 15px 0 30px -15px rgba(255,0,68,0.0); }
      50% { border-left-color: var(--neon-red); box-shadow: inset 15px 0 30px -15px rgba(255,0,68,0.4), 0 0 20px rgba(255,0,68,0.2); }
      100% { border-left-color: #440011; box-shadow: inset 15px 0 30px -15px rgba(255,0,68,0.0); }
    }

    .pulse-green { animation: breath-green 2.5s infinite ease-in-out; }
    .pulse-green .card-title { color: var(--neon-green) !important; text-shadow: 0 0 10px rgba(0,255,85,0.5) !important; }
    
    .pulse-red { animation: breath-red 2.5s infinite ease-in-out; }
    .pulse-red .card-title { color: var(--neon-red) !important; text-shadow: 0 0 10px rgba(255,0,68,0.5) !important; }


    /* --- 4. DIGITAL NUMBER DISPLAY (SLOT ENGINE) --- */
    .number-display {
      background: #020306;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      height: calc(var(--slot-height) + 16px);
      margin: 10px 0;
      display: flex;
      align-items: center;
      padding: 0 15px;
      position: relative;
      overflow: hidden; 
    }

    /* Hologram Scanlines */
    .number-display::after {
      content: "";
      position: absolute; inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(255,255,255,0.03) 2px,
        rgba(255,255,255,0.03) 4px
      );
      pointer-events: none;
      z-index: 10;
    }

    .slot-machine {
      display: flex;
      align-items: center;
      font-family: 'Space Mono', monospace;
      font-size: 34px;
      height: var(--slot-height);
      position: relative;
      z-index: 5;
    }

    .currency {
      margin-right: 12px;
      line-height: var(--slot-height);
    }

    .reel-wrapper {
      height: var(--slot-height);
      overflow: hidden; 
      display: inline-block;
      vertical-align: top;
    }
    
    .reel-strip {
      display: flex;
      flex-direction: column;
      will-change: transform;
    }
    
    .reel-digit, .static-char {
      height: var(--slot-height);
      line-height: var(--slot-height);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Neon Number Themes */
    .theme-white { color: var(--neon-white); text-shadow: 0 0 12px rgba(255,255,255,0.8), 0 0 25px rgba(255,255,255,0.4); }
    .theme-green { color: var(--neon-green); text-shadow: 0 0 12px rgba(0,255,85,0.8), 0 0 25px rgba(0,255,85,0.4); }
    .theme-red { color: var(--neon-red); text-shadow: 0 0 12px rgba(255,0,68,0.8), 0 0 25px rgba(255,0,68,0.4); }
    .theme-yellow { color: var(--neon-yellow); text-shadow: 0 0 12px rgba(252,238,10,0.8), 0 0 25px rgba(252,238,10,0.4); }


    /* --- 5. STATIC SUB-INFO (Net Worth Balance/Debt) --- */
    .sub-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: auto;
    }
    .sub-info span { 
      color: var(--neon-white); 
      font-weight: 700; 
      font-family: 'Space Mono', monospace;
      text-shadow: 0 0 8px rgba(255,255,255,0.3);
    }

    /* --- 6. BLANK RIGHT COLUMN (SCI-FI STYLE) --- */
    .blank-chart-box {
      background: rgba(6, 11, 25, 0.4);
      border: 1px solid rgba(0, 255, 255, 0.1);
      border-radius: 8px;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    /* Sci-Fi Radar/Targeting aesthetic for empty state */
    .blank-chart-box::before {
      content: '';
      position: absolute;
      width: 300px; height: 300px;
      border: 1px dashed rgba(0, 255, 255, 0.2);
      border-radius: 50%;
    }
    .blank-chart-box::after {
      content: '';
      position: absolute;
      width: 100%; height: 1px;
      background: rgba(0, 255, 255, 0.1);
    }

    .blank-text {
      color: rgba(0, 255, 255, 0.3);
      font-size: 1.5rem;
      letter-spacing: 6px;
      text-transform: uppercase;
      position: relative;
      z-index: 2;
    }

    /* Loader */
    #loader {
      position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s;
    }
    .cyber-spinner {
      width: 50px; height: 50px;
      border: 2px solid transparent;
      border-top-color: var(--neon-yellow);
      border-bottom-color: var(--neon-yellow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .cyber-spinner::before {
      content: ''; position: absolute; inset: 5px;
      border: 2px solid transparent; border-left-color: var(--neon-white); border-right-color: var(--neon-white);
      border-radius: 50%; animation: spin-reverse 0.5s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes spin-reverse { to { transform: rotate(-360deg); } }

    @media (max-width: 1024px) {
      .dashboard-layout { grid-template-columns: 1fr; grid-template-rows: auto 500px; height: auto; }
      body { overflow-y: auto; }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loader">
    <div class="cyber-spinner"></div>
    <div style="margin-top:20px; color:var(--neon-yellow); font-size:1rem; letter-spacing:4px; text-shadow: 0 0 10px rgba(252,238,10,0.5);">INITIALIZING SYSTEMS...</div>
  </div>

  <div class="dashboard-layout">
    
    <!-- LEFT COLUMN: 4 KPI CARDS -->
    <div class="left-column">
      
      <!-- 1. TRUE NET WORTH (WHITE) -->
      <div class="kpi-card card-white">
        <div class="card-title">TRUE NET WORTH</div>
        <div class="number-display">
          <div class="slot-machine theme-white">
            <span class="currency">‡ß≥</span>
            <div id="slot-net"></div>
          </div>
        </div>
        <div class="sub-info">
          <div>LIQUID: <span id="lbl-bal">...</span></div>
          <div>DEBT: <span id="lbl-debt">...</span></div>
        </div>
      </div>

      <!-- 2. CASHFLOW (YELLOW BASE, PULSES GREEN/RED) -->
      <div class="kpi-card card-flow-base" id="card-flow">
        <div class="card-title">CASHFLOW THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine theme-yellow" id="theme-flow">
            <span class="currency">‡ß≥</span>
            <div id="slot-flow"></div>
          </div>
        </div>
      </div>

      <!-- 3. INCOME (GREEN) -->
      <div class="kpi-card card-green">
        <div class="card-title">INCOME THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine theme-green">
            <span class="currency">‡ß≥</span>
            <div id="slot-inc"></div>
          </div>
        </div>
      </div>

      <!-- 4. EXPENSE (RED) -->
      <div class="kpi-card card-red">
        <div class="card-title">EXPENSE THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine theme-red">
            <span class="currency">‡ß≥</span>
            <div id="slot-exp"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN: SCI-FI BLANK AREA -->
    <div class="right-column">
      <div class="blank-chart-box">
        <div class="blank-text">AWAITING VISUALS</div>
      </div>
    </div>

  </div>

  <script>
    const FMT = (num) => Math.abs(num).toLocaleString('en-US');

    /**
     * ‚öôÔ∏è BULLETPROOF SCI-FI SLOT MACHINE ENGINE
     * Hard-coded height (50px) perfectly matches CSS to prevent clipping.
     */
    class SlotMachine {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.slotHeight = 50; 
      }

      prepare() {
        this.container.innerHTML = '<div style="font-size:1.5rem; opacity:0.3; letter-spacing:2px;">CALCULATING...</div>';
      }

      async spinTo(targetValue, isNegative = false) {
        this.container.innerHTML = ''; 
        
        if (isNegative) {
          const negSign = document.createElement('div');
          negSign.className = 'static-char';
          negSign.innerText = '-';
          this.container.appendChild(negSign);
        }

        const valStr = Math.abs(targetValue).toLocaleString('en-US');
        const stripsToAnimate =[];

        for (let i = 0; i < valStr.length; i++) {
          const char = valStr[i];
          
          if (char === ',') {
            const comma = document.createElement('div');
            comma.className = 'static-char';
            comma.innerText = ',';
            this.container.appendChild(comma);
          } else {
            const wrapper = document.createElement('div');
            wrapper.className = 'reel-wrapper';
            
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            
            // Generate random digital scramble effect
            let sequenceHTML = '';
            const spins = 30; 
            for(let loop = 0; loop < spins; loop++) {
              sequenceHTML += `<div class="reel-digit">${Math.floor(Math.random() * 10)}</div>`;
            }
            // Append final correct digit
            sequenceHTML += `<div class="reel-digit">${char}</div>`;
            
            strip.innerHTML = sequenceHTML;
            wrapper.appendChild(strip);
            this.container.appendChild(wrapper);
            
            stripsToAnimate.push({
              element: strip,
              offset: -(spins * this.slotHeight) // Perfect mathematical lock
            });
          }
        }

        // Wait a frame to allow DOM rendering
        await new Promise(r => setTimeout(r, 50));

        // Animate left to right
        stripsToAnimate.forEach((item, index) => {
          const delay = index * 150; 
          setTimeout(() => {
            item.element.style.transition = 'transform 2.5s cubic-bezier(0.1, 0.9, 0.2, 1)';
            item.element.style.transform = `translateY(${item.offset}px)`;
          }, delay);
        });
      }
    }

    /**
     * üöÄ MAIN INITIALIZATION & LOGIC
     */
    async function init() {
      const slots = {
        net: new SlotMachine('slot-net'),
        flow: new SlotMachine('slot-flow'),
        inc: new SlotMachine('slot-inc'),
        exp: new SlotMachine('slot-exp')
      };

      Object.values(slots).forEach(s => s.prepare());

      try {
        const res = await fetch('/api?t=' + Date.now());
        if (!res.ok) throw new Error("API Route failed");
        const data = await res.json();
        if(data.backendError) throw new Error(data.backendError);

        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        // 1. Net Worth (White)
        slots.net.spinTo(data.summary.netWorth, data.summary.netWorth < 0);
        document.getElementById('lbl-bal').innerText = '‡ß≥' + FMT(data.summary.balance);
        document.getElementById('lbl-debt').innerText = '‡ß≥' + FMT(data.summary.totalDebt);

        // 2. Cashflow Logic (Breathing Green vs Red)
        const flowCard = document.getElementById('card-flow');
        const flowTheme = document.getElementById('theme-flow');
        
        flowTheme.classList.remove('theme-yellow'); // Remove default

        if (data.kpis.current.cashflow >= 0) {
            flowCard.classList.add('pulse-green');
            flowTheme.classList.add('theme-green');
        } else {
            flowCard.classList.add('pulse-red');
            flowTheme.classList.add('theme-red');
        }
        slots.flow.spinTo(data.kpis.current.cashflow, data.kpis.current.cashflow < 0);

        // 3. Income (Green)
        slots.inc.spinTo(data.kpis.current.income);

        // 4. Expense (Red)
        slots.exp.spinTo(data.kpis.current.expense);

      } catch (e) {
        console.error("System Error:", e);
        
        // MOCK DATA FALLBACK (If API disconnected, UI still works perfectly)
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        slots.net.spinTo(1245000);
        document.getElementById('lbl-bal').innerText = "‡ß≥245,000";
        document.getElementById('lbl-debt').innerText = "‡ß≥12,000";

        // Test Positive Pulse Logic
        document.getElementById('card-flow').classList.add('pulse-green');
        document.getElementById('theme-flow').classList.remove('theme-yellow');
        document.getElementById('theme-flow').classList.add('theme-green');
        slots.flow.spinTo(45200);

        slots.inc.spinTo(85000);
        slots.exp.spinTo(39800);
      }
    }

    window.onload = init;
  </script>
</body>
</html>
