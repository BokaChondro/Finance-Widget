<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VIP Casino Finance</title>
  <style>
    :root {
      --bg: #191919;
      --card-bg: #222222;
      --gold: #FFD700;
      --gold-dim: rgba(255, 215, 0, 0.3);
      --green: #00FF66;
      --green-dim: rgba(0, 255, 102, 0.2);
      --red: #FF3366;
      --red-dim: rgba(255, 51, 102, 0.2);
      --text: #F0F0F0;
      --muted: #888888;
      --radius: 16px;
    }

    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    
    body {
      margin: 0; padding: 16px; background: var(--bg); color: var(--text);
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 100vh; overflow: hidden;
    }

    /* --- Left Column: KPI Cards --- */
    .kpi-col { display: grid; grid-template-rows: repeat(4, 1fr); gap: 16px; }
    
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px 20px;
      position: relative;
      display: flex; flex-direction: column; justify-content: space-between;
      background-image: radial-gradient(circle at center, rgba(255,255,255,0.03) 0, transparent 2px);
      background-size: 8px 8px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    .card.gold { border-left: 3px solid var(--gold); box-shadow: -5px 0 15px var(--gold-dim); }
    .card.dynamic-green { border-left: 3px solid var(--green); box-shadow: -5px 0 15px var(--green-dim); }
    .card.dynamic-red { border-left: 3px solid var(--red); box-shadow: -5px 0 15px var(--red-dim); }
    .card.green { border-left: 3px solid var(--green); box-shadow: -5px 0 15px var(--green-dim); }
    .card.red { border-left: 3px solid var(--red); box-shadow: -5px 0 15px var(--red-dim); }

    .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
    
    .value { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; margin: 4px 0; font-variant-numeric: tabular-nums; }
    .val-gold { color: var(--gold); text-shadow: 0 0 10px var(--gold-dim); }
    .val-green { color: var(--green); text-shadow: 0 0 10px var(--green-dim); }
    .val-red { color: var(--red); text-shadow: 0 0 10px var(--red-dim); }

    .insight-container { perspective: 1000px; height: 20px; position: relative; width: 100%; margin-top: 5px;}
    .insight-flipper {
      width: 100%; height: 100%; position: absolute;
      transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
    }
    .insight-front, .insight-back {
      width: 100%; height: 100%; position: absolute; backface-visibility: hidden;
      font-size: 13px; color: #BBBBBB; font-style: italic; display: flex; align-items: center;
    }
    .insight-back { transform: rotateX(180deg); }
    .flip-active { transform: rotateX(180deg); }

    .sub-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); font-family: monospace; margin-top: 4px;}

    /* --- Right Column: Charts & Ledger --- */
    .right-col { display: grid; grid-template-rows: 1.5fr 1fr; gap: 20px; }
    
    .panel { background: var(--card-bg); border-radius: var(--radius); padding: 20px; border: 1px solid rgba(255,255,255,0.05); display:flex; flex-direction: column;}
    .panel-title { font-size: 14px; font-weight: bold; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; text-shadow: 0 0 5px var(--gold-dim); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;}

    .chart-container { flex-grow: 1; display: flex; align-items: flex-end; justify-content: space-around; padding-top: 10px; }
    .stack-group { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.2s; }
    .stack-group:hover { transform: translateY(-5px); }
    .chips { display: flex; align-items: flex-end; gap: 4px; height: 120px; }
    .chip-col { display: flex; flex-direction: column-reverse; justify-content: flex-start; gap: 2px; width: 20px;}
    .chip { width: 20px; height: 6px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.5); box-shadow: inset 0 1px 1px rgba(255,255,255,0.3); }
    .chip.inc { background: var(--green); }
    .chip.exp { background: var(--red); }
    .month-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }

    .ledger-list { overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; padding-right: 5px;}
    .ledger-list::-webkit-scrollbar { width: 4px; }
    .ledger-list::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; }
    
    .iou-slip {
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px), #2A2A2A;
      border-left: 2px dashed var(--muted);
      padding: 10px 14px; border-radius: 4px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .iou-info h4 { margin: 0; font-size: 14px; color: var(--text); }
    .iou-info p { margin: 2px 0 0 0; font-size: 11px; color: var(--muted); }
    .iou-amt { font-weight: bold; font-family: monospace; font-size: 14px; }
    .urgent { border-left-color: var(--red); box-shadow: inset 2px 0 10px var(--red-dim); }
    .urgent .iou-info p, .urgent .iou-amt { color: var(--red); }
    
    .loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--bg); z-index: 10; font-family: monospace; color: var(--gold); font-size: 18px; text-align:center; padding: 20px;}
  </style>
</head>
<body>
  <div id="loader" class="loading">CONNECTING TO VIP SERVER...</div>

  <div class="kpi-col">
    <div class="card gold">
      <div class="card-header"><span>üíé True Net Worth</span></div>
      <div class="value val-gold" id="val-net">‡ß≥0</div>
      <div class="sub-stats">
        <span id="sub-bal">Bal: ‡ß≥0</span>
        <span id="sub-debt">Debt: ‡ß≥0</span>
      </div>
    </div>

    <div class="card" id="card-flow">
      <div class="card-header"><span id="icon-flow">‚öñÔ∏è 30-Day Cash Flow</span></div>
      <div class="value" id="val-flow">‡ß≥0</div>
      <div class="insight-container">
        <div class="insight-flipper" id="flip-flow">
          <div class="insight-front" id="txt-flow-1">Loading insight...</div>
          <div class="insight-back" id="txt-flow-2">Analyzing data...</div>
        </div>
      </div>
    </div>

    <div class="card green">
      <div class="card-header"><span>üìà 30-Day Income</span></div>
      <div class="value val-green" id="val-inc">‡ß≥0</div>
      <div class="insight-container">
        <div class="insight-flipper" id="flip-inc">
          <div class="insight-front" id="txt-inc-1">Loading insight...</div>
          <div class="insight-back" id="txt-inc-2">Analyzing data...</div>
        </div>
      </div>
    </div>

    <div class="card red">
      <div class="card-header"><span>üìâ 30-Day Expense</span></div>
      <div class="value val-red" id="val-exp">‡ß≥0</div>
      <div class="insight-container">
        <div class="insight-flipper" id="flip-exp">
          <div class="insight-front" id="txt-exp-1">Loading insight...</div>
          <div class="insight-back" id="txt-exp-2">Analyzing data...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="right-col">
    <div class="panel">
      <div class="panel-title">Past 6 Months (Winnings vs Losses)</div>
      <div class="chart-container" id="chip-chart"></div>
    </div>

    <div class="panel">
      <div class="panel-title">The House Ledger (Outstanding)</div>
      <div class="ledger-list" id="ledger-list"></div>
    </div>
  </div>

  <script>
    const fmt = (n) => "‡ß≥" + Math.abs(n).toLocaleString();

    function spinNumber(el, finalValue) {
      const duration = 1200; 
      const start = Date.now();
      const isNeg = finalValue < 0;
      
      const timer = setInterval(() => {
        const passed = Date.now() - start;
        if (passed > duration) {
          clearInterval(timer);
          el.innerText = (isNeg ? "-" : "") + fmt(finalValue);
        } else {
          const randomVal = Math.floor(Math.random() * Math.abs(finalValue) * 1.5);
          el.innerText = (isNeg ? "-" : "") + fmt(randomVal);
        }
      }, 40); 
    }

    function startRotator(flipId, textFrontId, textBackId, templates) {
      if(!templates || templates.length === 0) return;
      let idx = 0;
      const flipper = document.getElementById(flipId);
      const front = document.getElementById(textFrontId);
      const back = document.getElementById(textBackId);
      
      front.innerText = templates[0];
      
      setInterval(() => {
        idx = (idx + 1) % templates.length;
        const isFlipped = flipper.classList.contains('flip-active');
        
        if (isFlipped) {
          front.innerText = templates[idx];
          flipper.classList.remove('flip-active');
        } else {
          back.innerText = templates[idx];
          flipper.classList.add('flip-active');
        }
      }, 10000); 
    }

    function buildChart(data) {
      const container = document.getElementById('chip-chart');
      let maxVal = 1;
      data.forEach(d => {
        if(d.income > maxVal) maxVal = d.income;
        if(d.expense > maxVal) maxVal = d.expense;
      });
      const chipValue = maxVal / 18; 

      data.forEach(month => {
        const incChipsCount = Math.ceil(month.income / chipValue) || 0;
        const expChipsCount = Math.ceil(month.expense / chipValue) || 0;
        
        const group = document.createElement('div');
        group.className = 'stack-group';
        group.title = `In: ${fmt(month.income)} | Out: ${fmt(month.expense)}`; 
        
        let incHtml = '', expHtml = '';
        for(let i=0; i<incChipsCount; i++) incHtml += `<div class="chip inc"></div>`;
        for(let i=0; i<expChipsCount; i++) expHtml += `<div class="chip exp"></div>`;

        group.innerHTML = `
          <div class="chips">
            <div class="chip-col">${incHtml}</div>
            <div class="chip-col">${expHtml}</div>
          </div>
          <div class="month-label">${month.label}</div>
        `;
        container.appendChild(group);
      });
    }

    function buildLedger(debts) {
      const container = document.getElementById('ledger-list');
      if(debts.length === 0) {
        container.innerHTML = `<div style="color:var(--muted); font-size:12px; text-align:center; margin-top:20px;">All accounts settled.</div>`;
        return;
      }

      debts.forEach(d => {
        const isUrgent = d.daysLeft.includes("Overdue") || parseInt(d.daysLeft.match(/\d+/)?.[0] || 99) <= 30;
        container.innerHTML += `
          <div class="iou-slip ${isUrgent ? 'urgent' : ''}">
            <div class="iou-info">
              <h4>${d.name}</h4>
              <p>${d.daysLeft}</p>
            </div>
            <div class="iou-amt">${fmt(d.amount)}</div>
          </div>
        `;
      });
    }

    async function loadData() {
      try {
        const res = await fetch('/api?t=' + Date.now());
        const text = await res.text();

        // üö® 1. Check if Cloudflare returned an HTML Error Page
        if (text.trim().startsWith('<')) {
          console.error("Received HTML instead of API Data:", text);
          document.getElementById('loader').innerText = "ERROR: CLOUDFLARE ROUTE NOT FOUND. Check your 'functions' folder structure!";
          return;
        }

        const data = JSON.parse(text);

        // üö® 2. Check if the API threw a custom error
        if (data.backendError) {
           document.getElementById('loader').innerText = "API ERROR: " + data.backendError;
           return;
        }
        
        document.getElementById('loader').style.display = 'none';

        spinNumber(document.getElementById('val-net'), data.summary.netWorth);
        document.getElementById('sub-bal').innerText = `Bal: ${fmt(data.summary.balance)}`;
        document.getElementById('sub-debt').innerText = `Debt: ${fmt(data.summary.totalDebt)}`;

        const flowCard = document.getElementById('card-flow');
        const flowVal = document.getElementById('val-flow');
        spinNumber(flowVal, data.kpis.current.cashflow);
        if(data.kpis.current.cashflow >= 0) {
          flowCard.classList.add('dynamic-green'); flowVal.classList.add('val-green');
        } else {
          flowCard.classList.add('dynamic-red'); flowVal.classList.add('val-red');
        }

        spinNumber(document.getElementById('val-inc'), data.kpis.current.income);
        spinNumber(document.getElementById('val-exp'), data.kpis.current.expense);

        startRotator('flip-flow', 'txt-flow-1', 'txt-flow-2', data.insights.cashflow);
        startRotator('flip-inc', 'txt-inc-1', 'txt-inc-2', data.insights.income);
        startRotator('flip-exp', 'txt-exp-1', 'txt-exp-2', data.insights.expense);

        buildChart(data.chartData);
        buildLedger(data.debts);

      } catch (err) {
        document.getElementById('loader').innerText = "CRITICAL FRONTEND ERROR. PRESS F12 AND CHECK CONSOLE.";
        console.error("Critical error:", err);
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>
