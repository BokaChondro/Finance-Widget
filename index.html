<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Casino Royale Finance</title>
  <style>
    /* --- 1. THE CASINO THEME ENGINE --- */
    :root {
      --bg: #191919;               /* Matches Notion Dark Mode */
      --felt-dark: #0f2215;        /* Deep Green Felt Base */
      --felt-light: #183621;       /* Lighter Green Texture */
      
      --gold: #D4AF37;
      --gold-gradient: linear-gradient(135deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
      --gold-glow: rgba(212, 175, 55, 0.5);
      
      --neon-green: #39FF14;
      --neon-red: #FF003C;
      
      --chip-red: #8a1c1c;
      --chip-green: #1c5c2a;
      
      --text-main: #EAEAEA;
      --text-muted: #8aa192;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 20px;
      background-color: var(--bg);
      color: var(--text-main);
      font-family: "Courier Prime", "Courier New", monospace; 
      height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* Loading Screen */
    #loader {
      position: fixed; inset: 0; background: #000; z-index: 999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--gold); letter-spacing: 4px; font-weight: bold; font-size: 14px;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid #333;
      border-top-color: var(--gold); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { to {transform: rotate(360deg);} }

    /* Layout */
    .dashboard-grid {
      display: grid; grid-template-columns: 1fr 1.3fr; gap: 20px;
      width: 100%; height: 100%;
    }
    .kpi-col { display: grid; grid-template-rows: repeat(4, 1fr); gap: 15px; }
    .right-col { display: grid; grid-template-rows: 1.5fr 1fr; gap: 20px; }

    /* --- 2. THE VIP CARDS (Felt Texture) --- */
    .card {
      position: relative;
      background-color: var(--felt-dark);
      /* Felt Noise Texture */
      background-image: radial-gradient(var(--felt-light) 1px, transparent 1px);
      background-size: 4px 4px;
      border-radius: 12px;
      padding: 15px;
      display: flex; flex-direction: column; justify-content: space-between;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
      border: 1px solid #222;
    }

    /* Metallic Borders */
    .border-gold { border-left: 4px solid; border-image: var(--gold-gradient) 1; box-shadow: -5px 0 15px rgba(212, 175, 55, 0.15); }
    .border-green { border-left: 4px solid var(--neon-green); box-shadow: -5px 0 15px rgba(57, 255, 20, 0.15); }
    .border-red { border-left: 4px solid var(--neon-red); box-shadow: -5px 0 15px rgba(255, 0, 60, 0.15); }

    /* Typography */
    .label {
      font-size: 11px; text-transform: uppercase; letter-spacing: 2px;
      color: var(--gold); text-shadow: 0 2px 2px rgba(0,0,0,1);
      display: flex; justify-content: space-between;
    }
    
    /* Slot Machine Numbers */
    .slot-val {
      font-family: "Georgia", serif; /* Classy Casino Font */
      font-size: 32px; font-weight: 700;
      margin: 2px 0; letter-spacing: -0.5px;
      white-space: nowrap;
    }
    .text-gold { 
      background: var(--gold-gradient); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(212,175,55,0.3);
    }
    .text-green { color: var(--neon-green); text-shadow: 0 0 10px rgba(57, 255, 20, 0.4); }
    .text-red { color: var(--neon-red); text-shadow: 0 0 10px rgba(255, 0, 60, 0.4); }

    /* 3D Text Flipper (The Dealer) */
    .dealer-area { height: 18px; perspective: 800px; overflow: hidden;}
    .flipper {
      width: 100%; height: 100%; position: relative;
      transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .front, .back {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      display: flex; align-items: center;
      font-size: 11px; color: var(--text-muted); font-style: italic;
    }
    .back { transform: rotateX(180deg); }
    .flipped { transform: rotateX(180deg); }

    /* --- 3. THE CHIP STACKS (Graph) --- */
    .panel-header {
      font-size: 11px; color: var(--gold); border-bottom: 1px solid #444;
      padding-bottom: 6px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
    }
    
    .chart-area {
      flex-grow: 1; display: flex; align-items: flex-end; justify-content: space-around;
      padding-bottom: 5px;
    }
    
    .stack-group {
      display: flex; gap: 4px; align-items: flex-end;
      cursor: pointer; transition: transform 0.2s;
    }
    .stack-group:hover { transform: translateY(-5px) scale(1.05); }

    .stack-col { display: flex; flex-direction: column-reverse; gap: 2px; }

    /* Realistic 3D Chip CSS */
    .chip {
      width: 20px; height: 6px;
      border-radius: 50%; /* Oval profile */
      border: 1px dashed rgba(255,255,255,0.3);
      box-shadow: 0 3px 0 rgba(0,0,0,0.5), inset 0 2px 3px rgba(255,255,255,0.2);
      position: relative;
    }
    .c-green { background: var(--chip-green); }
    .c-red { background: var(--chip-red); }
    
    .month-lbl { margin-top: 6px; font-size: 9px; color: #666; text-align: center; }

    /* --- 4. THE HOUSE LEDGER (Debts) --- */
    .ledger-scroll { overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px;}
    .ledger-scroll::-webkit-scrollbar { width: 3px; background: #222; }
    .ledger-scroll::-webkit-scrollbar-thumb { background: var(--gold); }

    .ticket {
      background: #EFEFEF; color: #111; /* Physical Paper Look */
      border-left: 4px solid #333;
      padding: 8px 10px; 
      display: flex; justify-content: space-between; align-items: center;
      transform: rotate(-0.5deg); /* Imperfect paper look */
      box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
      transition: transform 0.2s;
    }
    .ticket:hover { transform: rotate(0deg) scale(1.02); }
    
    .t-urgent { 
      background: #ffdbdb; 
      border-left-color: var(--neon-red); 
      color: #8a0000; font-weight: bold; 
    }
    
    .t-name { font-size: 12px; font-weight: 800; text-transform: uppercase; }
    .t-meta { font-size: 10px; opacity: 0.8; }
    .t-amt { font-family: monospace; font-size: 13px; font-weight: bold; }

  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loader">
    <div class="spinner"></div>
    <div id="status-text">OPENING VIP LOUNGE...</div>
  </div>

  <div class="dashboard-grid">
    
    <!-- LEFT: KPI CARDS -->
    <div class="kpi-col">
      
      <!-- Net Worth -->
      <div class="card border-gold">
        <div class="label"><span>üíé VIP NET WORTH</span></div>
        <div class="slot-val text-gold" id="val-net">---</div>
        <div class="label" style="border:none; margin:0; font-size:9px; color:var(--text-muted); text-shadow:none;">
          <span id="sub-bal">Bal: ---</span> <span id="sub-debt">Debt: ---</span>
        </div>
      </div>

      <!-- Cash Flow -->
      <div class="card border-gold" id="card-flow">
        <div class="label"><span>‚öñÔ∏è MONTHLY HAND</span></div>
        <div class="slot-val" id="val-flow">---</div>
        <div class="dealer-area">
          <div class="flipper" id="flip-flow">
            <div class="front" id="txt-flow-1">Reading table...</div>
            <div class="back" id="txt-flow-2">Calculating odds...</div>
          </div>
        </div>
      </div>

      <!-- Income -->
      <div class="card border-green">
        <div class="label"><span>üíµ WINNINGS (IN)</span></div>
        <div class="slot-val text-green" id="val-inc">---</div>
        <div class="dealer-area">
          <div class="flipper" id="flip-inc">
            <div class="front" id="txt-inc-1">Counting chips...</div>
            <div class="back" id="txt-inc-2">...</div>
          </div>
        </div>
      </div>

      <!-- Expense -->
      <div class="card border-red">
        <div class="label"><span>üìâ LOSSES (OUT)</span></div>
        <div class="slot-val text-red" id="val-exp">---</div>
        <div class="dealer-area">
          <div class="flipper" id="flip-exp">
            <div class="front" id="txt-exp-1">Reviewing bets...</div>
            <div class="back" id="txt-exp-2">...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: CHIPS & LEDGER -->
    <div class="right-col">
      
      <!-- Chip Stacks -->
      <div class="card">
        <div class="panel-header">LAST 6 ROUNDS (HISTORY)</div>
        <div class="chart-area" id="chip-chart"></div>
      </div>

      <!-- House Ledger -->
      <div class="card">
        <div class="panel-header">HOUSE LEDGER (OUTSTANDING)</div>
        <div class="ledger-scroll" id="ledger-list"></div>
      </div>

    </div>
  </div>

  <script>
    const fmt = (n) => "‡ß≥" + Math.abs(n).toLocaleString();

    // 1. Slot Machine Animation
    function runSlot(elementId, endValue) {
      const el = document.getElementById(elementId);
      if(!el) return;
      
      let current = 0;
      const target = Math.abs(endValue);
      const step = Math.max(1, Math.floor(target / 30)); 
      
      const interval = setInterval(() => {
        current += step;
        if (current >= target) {
          clearInterval(interval);
          el.innerText = (endValue < 0 ? "-" : "") + fmt(endValue);
        } else {
          // Add random jitter to last digit for blur effect
          let display = current - (current % 10) + Math.floor(Math.random()*9);
          el.innerText = (endValue < 0 ? "-" : "") + fmt(display);
        }
      }, 30);
    }

    // 2. The Dealer (3D Text Flipper)
    function startDealer(flipId, fId, bId, messages) {
      if(!messages || messages.length === 0) return;
      let idx = 0;
      const flipper = document.getElementById(flipId);
      const front = document.getElementById(fId);
      const back = document.getElementById(bId);

      front.innerText = messages[0];

      setInterval(() => {
        idx = (idx + 1) % messages.length;
        
        if (!flipper.classList.contains('flipped')) {
          back.innerText = messages[idx];
          flipper.classList.add('flipped');
        } else {
          front.innerText = messages[idx];
          flipper.classList.remove('flipped');
        }
      }, 8000); // Flip every 8 seconds
    }

    // 3. Render 3D Chip Stacks
    function stackChips(data) {
      const container = document.getElementById('chip-chart');
      
      // Find max to scale height (max 12 chips high)
      let max = 0;
      data.forEach(d => { 
        if(d.income > max) max = d.income; 
        if(d.expense > max) max = d.expense; 
      });
      const valPerChip = max / 10; 

      data.forEach(m => {
        const inC = Math.ceil(m.income / valPerChip) || 1;
        const exC = Math.ceil(m.expense / valPerChip) || 1;
        
        // Create the group container
        const group = document.createElement('div');
        group.style.display = 'flex';
        group.style.flexDirection = 'column';
        group.style.alignItems = 'center';

        // Inner HTML for the two stacks (Green left, Red right)
        let html = `<div class="stack-group" title="${m.label}\nIn: ${fmt(m.income)}\nOut: ${fmt(m.expense)}">`;
        
        // Green Column
        html += `<div class="stack-col">`;
        for(let i=0; i<inC; i++) html += `<div class="chip c-green"></div>`;
        html += `</div>`;

        // Red Column
        html += `<div class="stack-col">`;
        for(let i=0; i<exC; i++) html += `<div class="chip c-red"></div>`;
        html += `</div>`;
        
        html += `</div>`; // End stack-group
        html += `<div class="month-lbl">${m.label}</div>`;
        
        group.innerHTML = html;
        container.appendChild(group);
      });
    }

    // 4. Render Debt Tickets
    function printTickets(debts) {
      const list = document.getElementById('ledger-list');
      if(!debts || debts.length === 0) {
        list.innerHTML = `<div style="text-align:center; color:#555; margin-top:20px; font-size:10px;">ALL BETS SETTLED</div>`;
        return;
      }

      debts.forEach(d => {
        // Parse "Pay in X Days" logic
        const daysNum = parseInt(d.daysLeft.match(/\d+/)?.[0]) || 999;
        const isUrgent = d.daysLeft.toLowerCase().includes('overdue') || daysNum < 30;
        
        list.innerHTML += `
          <div class="ticket ${isUrgent ? 't-urgent' : ''}">
            <div>
              <div class="t-name">${d.name}</div>
              <div class="t-meta">${d.daysLeft}</div>
            </div>
            <div class="t-amt">${fmt(d.amount)}</div>
          </div>
        `;
      });
    }

    // MAIN LOAD FUNCTION
    async function init() {
      try {
        const res = await fetch('/api?t=' + Date.now());
        const text = await res.text();
        
        // HTML Error Check
        if(text.trim().startsWith('<')) {
          throw new Error("Cloudflare Config Error: API route returned HTML");
        }

        const data = JSON.parse(text);

        // API Error Check
        if(data.backendError) {
          throw new Error(data.backendError);
        }

        // Hide Loader
        document.getElementById('loader').style.display = 'none';

        // 1. Net Worth & Summary
        runSlot('val-net', data.summary.netWorth);
        document.getElementById('sub-bal').innerText = `Bal: ${fmt(data.summary.balance)}`;
        document.getElementById('sub-debt').innerText = `Debt: ${fmt(data.summary.totalDebt)}`;

        // 2. Cash Flow
        const cf = data.kpis.current.cashflow;
        const cfCard = document.getElementById('card-flow');
        const cfVal = document.getElementById('val-flow');
        
        runSlot('val-flow', cf);
        if(cf >= 0) {
          cfVal.classList.add('text-green');
          cfCard.classList.add('border-green');
        } else {
          cfVal.classList.add('text-red');
          cfCard.classList.add('border-red');
        }
        startDealer('flip-flow', 'txt-flow-1', 'txt-flow-2', data.insights.cashflow);

        // 3. Income & Expense
        runSlot('val-inc', data.kpis.current.income);
        startDealer('flip-inc', 'txt-inc-1', 'txt-inc-2', data.insights.income);

        runSlot('val-exp', data.kpis.current.expense);
        startDealer('flip-exp', 'txt-exp-1', 'txt-exp-2', data.insights.expense);

        // 4. Draw Viz
        stackChips(data.chartData);
        printTickets(data.debts);

      } catch(e) {
        console.error(e);
        document.getElementById('status-text').innerText = "SYSTEM ERROR";
        document.getElementById('status-text').style.color = "red";
        
        const errDiv = document.createElement('div');
        errDiv.style.color = "#666";
        errDiv.style.fontSize = "10px";
        errDiv.style.marginTop = "10px";
        errDiv.innerText = e.message;
        document.getElementById('loader').appendChild(errDiv);
      }
    }

    window.onload = init;
  </script>
</body>
</html>
