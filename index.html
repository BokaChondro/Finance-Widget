<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notion KPI Test</title>
  <style>
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .wrap{ padding:16px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button{
      background:#111; color:#fff; border:1px solid #333;
      padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    button:hover{ border-color:#555; }
    a{ color:#7fb3ff; text-decoration:none; }
    pre{
      margin-top:12px;
      background:#0b0b0b;
      border:1px solid #222;
      border-radius:12px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .muted{ color:#aaa; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <button id="btn">Test fetch</button>
      <span class="muted">API:</span>
      <a id="apiLink" target="_blank" rel="noreferrer">open worker</a>
      <span class="muted" id="status">Idle</span>
    </div>

    <pre id="out">Click "Test fetch"</pre>
  </div>

  <script>
    const API_URL = "https://notion-kpi-api.windows-10-mugdho.workers.dev/"; // <-- this is correct

    const out = document.getElementById("out");
    const statusEl = document.getElementById("status");
    const apiLink = document.getElementById("apiLink");
    apiLink.href = API_URL;
    apiLink.textContent = API_URL;

    async function test() {
      try {
        statusEl.textContent = "Fetching...";
        out.textContent = "";

        // cache buster avoids embed caching issues
        const url = API_URL + "?t=" + Date.now();

        const r = await fetch(url, { mode: "cors", cache: "no-store" });

        const text = await r.text(); // read raw
        statusEl.textContent = `HTTP ${r.status}`;

        out.textContent =
          "=== Raw response (first 1500 chars) ===\n" +
          text.slice(0, 1500) +
          "\n\n=== Parsed JSON (if possible) ===\n";

        try {
          const j = JSON.parse(text);
          out.textContent += JSON.stringify(j, null, 2);
        } catch {
          out.textContent += "(Not JSON)";
        }
      } catch (e) {
        statusEl.textContent = "FAILED";
        out.textContent =
          "Fetch error:\n" + (e && e.message ? e.message : String(e)) +
          "\n\nMost common cause: missing CORS headers on the Worker response.";
      }
    }

    document.getElementById("btn").addEventListener("click", test);

    // auto test once on load
    test();
  </script>
</body>
</html>
