<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Dashboard</title>
  
  <!-- Modern Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* --- 1. CORE VARIABLES & THEME --- */
    :root {
      --bg: #191919;
      --card-bg: #222222;
      --card-border: #333333;
      
      --gold: #FFD700;
      --gold-glow: rgba(255, 215, 0, 0.4);
      
      --neon-green: #00FF66;
      --green-glow: rgba(0, 255, 102, 0.4);
      
      --neon-red: #FF0055;
      --red-glow: rgba(255, 0, 85, 0.4);
      
      --text-main: #FFFFFF;
      --text-muted: #888888;
      
      /* Strict dimension for the slot machine to prevent clipping bugs */
      --slot-height: 50px; 
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 30px;
      overflow-x: hidden;
    }

    /* --- 2. LAYOUT: 1x4 Left Col, 1 Big Right Col --- */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 350px 1fr; /* Left col fixed width, right col takes remaining */
      gap: 30px;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      height: calc(100vh - 60px);
    }

    .left-column {
      display: grid;
      grid-template-rows: repeat(4, 1fr);
      gap: 20px;
      height: 100%;
    }

    .right-column {
      display: flex;
      height: 100%;
    }

    /* --- 3. MODERN CARDS --- */
    .kpi-card {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
    }

    /* Neon Accent Lines */
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 4px; height: 100%;
    }
    .card-gold::before { background: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }
    .card-green::before { background: var(--neon-green); box-shadow: 0 0 15px var(--green-glow); }
    .card-red::before { background: var(--neon-red); box-shadow: 0 0 15px var(--red-glow); }

    .card-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* --- 4. BULLETPROOF SLOT MACHINE DISPLAY --- */
    .number-display {
      background: #111;
      border-radius: 8px;
      border: 1px solid #000;
      box-shadow: inset 0 4px 10px rgba(0,0,0,0.8);
      height: calc(var(--slot-height) + 20px);
      margin: 10px 0;
      display: flex;
      align-items: center;
      padding: 0 15px;
      overflow: hidden; /* Contains the spinning reels securely */
    }

    .slot-machine {
      display: flex;
      align-items: center;
      font-family: 'Space Mono', monospace;
      font-size: 32px;
      font-weight: 700;
      height: var(--slot-height);
    }

    .currency {
      margin-right: 8px;
      line-height: var(--slot-height);
    }

    /* Individual Reel Elements */
    .reel-wrapper {
      height: var(--slot-height);
      overflow: hidden; /* Clips exact digit height */
      display: inline-block;
      vertical-align: top;
    }
    
    .reel-strip {
      display: flex;
      flex-direction: column;
      will-change: transform;
    }
    
    .reel-digit, .static-char {
      height: var(--slot-height);
      line-height: var(--slot-height); /* Mathematically perfect centering */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Neon Themes for Numbers */
    .theme-gold { color: var(--gold); text-shadow: 0 0 10px var(--gold-glow); }
    .theme-green { color: var(--neon-green); text-shadow: 0 0 10px var(--green-glow); }
    .theme-red { color: var(--neon-red); text-shadow: 0 0 10px var(--red-glow); }

    /* --- 5. 3D INSIGHT FLIPPER --- */
    .insight-container {
      perspective: 1000px;
      height: 20px;
      width: 100%;
    }
    .flipper {
      width: 100%; height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .flipper.flipped { transform: rotateX(180deg); }
    
    .insight-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .insight-back {
      transform: rotateX(180deg);
      color: var(--text-main);
    }

    /* Static sub-info (for Net Worth) */
    .sub-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .sub-info span { color: var(--text-main); font-weight: 600; font-family: 'Space Mono', monospace;}

    /* --- 6. BLANK RIGHT COLUMN --- */
    .blank-chart-box {
      background-color: var(--card-bg);
      border: 1px dashed #444;
      border-radius: 16px;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #444;
      font-size: 1.2rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      position: relative;
    }

    /* Loader */
    #loader {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #333; border-top-color: var(--neon-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1024px) {
      .dashboard-layout { grid-template-columns: 1fr; grid-template-rows: auto 500px; height: auto; }
      body { overflow-y: auto; }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loader">
    <div class="spinner"></div>
    <div style="margin-top:20px; color:#888; font-size:0.8rem; letter-spacing:2px;">SYNCING DATA...</div>
  </div>

  <div class="dashboard-layout">
    
    <!-- LEFT COLUMN: 4 KPI CARDS -->
    <div class="left-column">
      
      <!-- 1. TRUE NET WORTH -->
      <div class="kpi-card card-gold">
        <div class="card-title">TRUE NET WORTH</div>
        <div class="number-display">
          <div class="slot-machine theme-gold">
            <span class="currency">‡ß≥</span>
            <div id="slot-net"></div>
          </div>
        </div>
        <div class="sub-info">
          <div>Balance: <span id="lbl-bal">...</span></div>
          <div>Total Debt: <span id="lbl-debt">...</span></div>
        </div>
      </div>

      <!-- 2. CASHFLOW -->
      <div class="kpi-card" id="card-flow">
        <div class="card-title">CASHFLOW THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine" id="theme-flow">
            <span class="currency">‡ß≥</span>
            <div id="slot-flow"></div>
          </div>
        </div>
        <div class="insight-container">
          <div class="flipper" id="flip-flow">
            <div class="insight-face front">Analyzing cashflow...</div>
            <div class="insight-face insight-back back">...</div>
          </div>
        </div>
      </div>

      <!-- 3. INCOME -->
      <div class="kpi-card card-green">
        <div class="card-title">INCOME THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine theme-green">
            <span class="currency">‡ß≥</span>
            <div id="slot-inc"></div>
          </div>
        </div>
        <div class="insight-container">
          <div class="flipper" id="flip-inc">
            <div class="insight-face front">Aggregating income...</div>
            <div class="insight-face insight-back back">...</div>
          </div>
        </div>
      </div>

      <!-- 4. EXPENSE -->
      <div class="kpi-card card-red">
        <div class="card-title">EXPENSE THIS MONTH</div>
        <div class="number-display">
          <div class="slot-machine theme-red">
            <span class="currency">‡ß≥</span>
            <div id="slot-exp"></div>
          </div>
        </div>
        <div class="insight-container">
          <div class="flipper" id="flip-exp">
            <div class="insight-face front">Tracking expenses...</div>
            <div class="insight-face insight-back back">...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN: BLANK AREA -->
    <div class="right-column">
      <div class="blank-chart-box">
        [ Chart / Graph Area Placeholder ]
      </div>
    </div>

  </div>

  <script>
    const FMT = (num) => Math.abs(num).toLocaleString('en-US');

    /**
     * ‚öôÔ∏è BULLETPROOF SLOT MACHINE ENGINE
     * Uses strict 50px heights. Impossible to clip or hide numbers.
     */
    class SlotMachine {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.slotHeight = 50; // Must exactly match CSS --slot-height
      }

      prepare() {
        this.container.innerHTML = '<div style="font-size:1.5rem; opacity:0.3;">...</div>';
      }

      async spinTo(targetValue, isNegative = false) {
        this.container.innerHTML = ''; 
        
        if (isNegative) {
          const negSign = document.createElement('div');
          negSign.className = 'static-char';
          negSign.innerText = '-';
          this.container.appendChild(negSign);
        }

        const valStr = Math.abs(targetValue).toLocaleString('en-US');
        const stripsToAnimate =[];

        for (let i = 0; i < valStr.length; i++) {
          const char = valStr[i];
          
          if (char === ',') {
            const comma = document.createElement('div');
            comma.className = 'static-char';
            comma.innerText = ',';
            this.container.appendChild(comma);
          } else {
            const wrapper = document.createElement('div');
            wrapper.className = 'reel-wrapper';
            
            const strip = document.createElement('div');
            strip.className = 'reel-strip';
            
            // Build 30 random numbers, then the target number at the end
            let sequenceHTML = '';
            const spins = 30; 
            for(let loop = 0; loop < spins; loop++) {
              sequenceHTML += `<div class="reel-digit">${Math.floor(Math.random() * 10)}</div>`;
            }
            sequenceHTML += `<div class="reel-digit">${char}</div>`;
            
            strip.innerHTML = sequenceHTML;
            wrapper.appendChild(strip);
            this.container.appendChild(wrapper);
            
            stripsToAnimate.push({
              element: strip,
              // Calculate exactly how far to push up based on fixed height
              offset: -(spins * this.slotHeight) 
            });
          }
        }

        // Wait a tick for DOM layout
        await new Promise(r => setTimeout(r, 50));

        // Animate left to right
        stripsToAnimate.forEach((item, index) => {
          const delay = index * 200; 
          setTimeout(() => {
            item.element.style.transition = 'transform 3s cubic-bezier(0.15, 0.85, 0.2, 1.05)';
            item.element.style.transform = `translateY(${item.offset}px)`;
          }, delay);
        });
      }
    }

    /**
     * üîÑ DIRECT INSIGHT FLIPPER
     * Simple, direct English sentences.
     */
    class InsightFlipper {
      constructor(flipId, messages) {
        this.flipper = document.getElementById(flipId);
        this.front = this.flipper.querySelector('.front');
        this.back = this.flipper.querySelector('.back');
        this.messages = messages || ["Data updated."];
        this.currentIndex = 0;
      }

      start() {
        if(this.messages.length <= 1) {
            this.front.innerText = this.messages[0];
            return;
        }
        this.front.innerText = this.messages[0];
        
        setInterval(() => {
          this.currentIndex = (this.currentIndex + 1) % this.messages.length;
          if (!this.flipper.classList.contains('flipped')) {
            this.back.innerText = this.messages[this.currentIndex];
            this.flipper.classList.add('flipped');
          } else {
            this.front.innerText = this.messages[this.currentIndex];
            this.flipper.classList.remove('flipped');
          }
        }, 6000);
      }
    }

    /**
     * üß† DATA PROCESSING: Overrides Casino Jargon with Direct English
     */
    function generateDirectInsights(kpis) {
      const cur = kpis.current;
      const last = kpis.last;
      const avg = kpis.averages;

      const flowDiff = Math.abs(cur.cashflow - avg.flow);
      const incDiff = Math.abs(cur.income - avg.inc);
      const expDiff = Math.abs(cur.expense - avg.exp);

      return {
        cashflow: cur.cashflow >= 0 ?[
          `You are saving ‡ß≥${FMT(cur.cashflow)} this month.`,
          `Which is ‡ß≥${FMT(flowDiff)} ${cur.cashflow > avg.flow ? 'more' : 'less'} than your 6-month average.`,
          `Cashflow increased by ‡ß≥${FMT(Math.abs(cur.cashflow - last.cashflow))} vs last month.`
        ] :[
          `You are negative ‡ß≥${FMT(cur.cashflow)} this month.`,
          `You spent more than you earned this period.`,
          `Missing your usual ‡ß≥${FMT(avg.flow)} average savings.`
        ],
        income: cur.income >= last.income ?[
          `Income is ‡ß≥${FMT(cur.income)} this month.`,
          `Which is ‡ß≥${FMT(incDiff)} higher than your 6-month average.`,
          `Earnings are up compared to last month.`
        ] :[
          `Income is ‡ß≥${FMT(cur.income)} this month.`,
          `Trailing your 6-month average by ‡ß≥${FMT(incDiff)}.`,
          `Earnings are slightly down vs last month.`
        ],
        expense: cur.expense > avg.exp ?[
          `Expenses are ‡ß≥${FMT(cur.expense)} this month.`,
          `Which is ‡ß≥${FMT(expDiff)} higher than your normal average.`,
          `Spending is elevated this period.`
        ] :[
          `Expenses are kept at ‡ß≥${FMT(cur.expense)} this month.`,
          `Which is ‡ß≥${FMT(expDiff)} below your normal average.`,
          `Good job keeping expenses low this period.`
        ]
      };
    }

    /**
     * üöÄ MAIN INITIALIZATION
     */
    async function init() {
      const slots = {
        net: new SlotMachine('slot-net'),
        flow: new SlotMachine('slot-flow'),
        inc: new SlotMachine('slot-inc'),
        exp: new SlotMachine('slot-exp')
      };

      Object.values(slots).forEach(s => s.prepare());

      try {
        const res = await fetch('/api?t=' + Date.now());
        if (!res.ok) throw new Error("API Route failed");
        const data = await res.json();
        if(data.backendError) throw new Error(data.backendError);

        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        // 1. Net Worth
        slots.net.spinTo(data.summary.netWorth, data.summary.netWorth < 0);
        document.getElementById('lbl-bal').innerText = '‡ß≥' + FMT(data.summary.balance);
        document.getElementById('lbl-debt').innerText = '‡ß≥' + FMT(data.summary.totalDebt);

        // Translate insights to simple English regardless of what API sends
        const directInsights = generateDirectInsights(data.kpis);

        // 2. Cashflow
        const flowCard = document.getElementById('card-flow');
        const flowTheme = document.getElementById('theme-flow');
        if (data.kpis.current.cashflow >= 0) {
            flowCard.classList.add('card-green');
            flowTheme.classList.add('theme-green');
        } else {
            flowCard.classList.add('card-red');
            flowTheme.classList.add('theme-red');
        }
        slots.flow.spinTo(data.kpis.current.cashflow, data.kpis.current.cashflow < 0);
        new InsightFlipper('flip-flow', directInsights.cashflow).start();

        // 3. Income
        slots.inc.spinTo(data.kpis.current.income);
        new InsightFlipper('flip-inc', directInsights.income).start();

        // 4. Expense
        slots.exp.spinTo(data.kpis.current.expense);
        new InsightFlipper('flip-exp', directInsights.expense).start();

      } catch (e) {
        console.error("System Error:", e);
        
        // FALLBACK MOCK DATA FOR TESTING UI
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 400);

        slots.net.spinTo(1245000);
        document.getElementById('lbl-bal').innerText = "‡ß≥245,000";
        document.getElementById('lbl-debt').innerText = "‡ß≥12,000";

        document.getElementById('card-flow').classList.add('card-green');
        document.getElementById('theme-flow').classList.add('theme-green');
        slots.flow.spinTo(45200);
        new InsightFlipper('flip-flow',["You are saving ‡ß≥45,200 this month.", "Which is ‡ß≥5,000 more than average."]).start();

        slots.inc.spinTo(85000);
        new InsightFlipper('flip-inc',["Income is ‡ß≥85,000 this month.", "Earnings are up compared to last month."]).start();

        slots.exp.spinTo(39800);
        new InsightFlipper('flip-exp',["Expenses are kept at ‡ß≥39,800.", "Good job keeping expenses low."]).start();
      }
    }

    window.onload = init;
  </script>
</body>
</html>
